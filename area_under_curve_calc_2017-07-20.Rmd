---
title: "area-under_curve"
author: "Stacey Harmer"
date: "7/20/2017"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

My goal is to automate a previously created function so that I can easily determine qPCR area-under-curve for individual genes and across unique time frames (time frames unique to each genotype and represent one circadian day).

```{r}
library(tidyverse)
library(MESS)
```

Below is the original code:

```{r}
Akiva.12deg<- read_csv("qRT-PCR_data_12c_6genes_n.csv") #read it in as a tibble
head(Akiva.12deg)
tail(Akiva.12deg)

```

Make the data wide
```{r}
PCR.12.wide <- spread(Akiva.12deg,key = gene, value = expn ) %>%
  mutate(gt.rep = paste(gt, rep, sep = "."))
head(PCR.12.wide)

```

Original code:

```{r}

PRR5_12deg_24_48.6 <- sapply(unique(PCR.12.wide$gt.rep), function(gt.rep) {
  tmp <- PCR.12.wide[PCR.12.wide$gt.rep==gt.rep,]
  auc(tmp$time,tmp$PRR5,type="spline", from =24, to = 48.6)
})
PRR5_12deg_24_48.6
```

I want to be able to step through each of the genes.  would it be better if I used long insetad of wide dataframe?

```{r}

Akiva.12deg <- Akiva.12deg %>%
  mutate(gt.rep = paste(gt, rep, sep = "."))

head(Akiva.12deg)

#all_12deg_24_48.6 <- sapply(unique(Akiva.12deg$gt.rep), function(gt.rep) {
#  gene <- Akiva.12deg[Akiva.12deg$gene==gene,],
#  tmp <- Akiva.12deg[Akiva.12deg$gt.rep==gt.rep,]
#  auc(tmp$time,tmp$gene,type="spline", from =24, to = 48.6)
#})

```
that failed. 

```{r}
head(PCR.12.wide)
```

I suspect I need to incoroprate something like the below

 for(i in 5:10)
    { 
      PCR.12.wide[, i];
    }
but I can't figure it out

Yes, that would be one way to do it, but I wonder if we could use summarize instead

```{r}
results <- Akiva.12deg %>%
  group_by(gene,gt,rep) %>%
  summarize(auc=auc(time,expn,type="spline", from =24, to = 48.6))
```

let's compare the prr5 results from this method and the Stacey's single call
```{r}
results %>% filter(gene=="PRR5")
```

```{r}
PRR5_12deg_24_48.6
```

Success!

### can we use lmer as function within summarize?

I will calculate the AUC for one circadian day for the differnet genotypes

### Col 
```{r}
library(MESS)

auc_Col <- Akiva.12deg %>%
  group_by(gene, rep, gt) %>%
  summarize(auc = auc(time, expn, type="spline", from =24, to = 48.6)) %>%
  filter(gt == "Col") %>%
  mutate(gt.biorep = paste(gt, rep, sep="."))

auc_Col
# and now spread so it's wide 

auc_Col <- spread(auc_Col, key = gene, value = auc )
```

### cca1 lhy
ccalhy: 21.5 hr   (24 to 45.5)
```{r}
auc_cca1lhy <- Akiva.12deg %>%
  group_by(gene, rep, gt) %>%
  summarize(auc = auc(time, expn, type="spline", from =24, to = 45.5)) %>%
  filter(gt == "cca1lhy") %>%
  mutate(gt.biorep = paste(gt, rep, sep="."))

auc_cca1lhy
# and now spread so it's wide 

auc_cca1lhy <- spread(auc_cca1lhy, key = gene, value = auc )

```

### rve468
rve468: 29.24     (24 to 53.2)
```{r}
auc_rve468 <- Akiva.12deg %>%
  group_by(gene, rep, gt) %>%
  summarize(auc = auc(time, expn, type="spline", from =24, to = 53.2)) %>%
  filter(gt == "rve468") %>%
  mutate(gt.biorep = paste(gt, rep, sep="."))

auc_rve468
# and now spread so it's wide 

auc_rve468 <- spread(auc_rve468, key = gene, value = auc )

```

### quint
quint: 25.5      (24 to 49.5)
```{r}
auc_quint <- Akiva.12deg %>%
  group_by(gene, rep, gt) %>%
  summarize(auc = auc(time, expn, type="spline", from =24, to = 49.5)) %>%
  filter(gt == "cca1lhyrve468") %>%
  mutate(gt.biorep = paste(gt, rep, sep="."))

auc_quint
# and now spread so it's wide 

auc_quint <- spread(auc_quint, key = gene, value = auc )

```

Great, now join them together.  

```{r}

auc_all <- bind_rows(auc_Col, auc_cca1lhy, auc_rve468, auc_quint)
auc_all
```

Now gather for easy ggplotting
```{r}
auc_all_gather <- auc_all %>%
  gather(key = "gene", value ="AUC", 4:9)

```

Now I can easily plot them all using facet

```{r}
# first, order genotypes appropriately
gt_order <- c("Col", "cca1lhy", "rve468", "cca1lhyrve468")

auc_all_gather <- auc_all_gather %>%
  mutate(gt = factor(gt, levels = gt_order)) %>%
  arrange(gt)

# now plot
auc_all_gather %>%
  group_by(gt) %>%
  ggplot(aes(color = gt)) +
  geom_boxplot(aes(x = gt, y=AUC)) + 
  facet_wrap(~gene)

```

Can I use lmer wiht summrize?

```{r}
library(lme4)
library(lmerTest)
head(auc_all_gather)
```

My attempt:

```{r}

#lmer_12deg <-  auc_all_gather %>%
#  group_by(gene, gt) %>%
#  summarize(lmer = lmer(AUC ~ gt + (1|rep))) 

```

failed.
